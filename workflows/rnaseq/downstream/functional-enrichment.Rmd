---
title: Functional enrichment analysis
output:
    html_document:
        code_folding: hide
        toc: true
        toc_float: true
        toc_depth: 3
---

```{r global_options, include=FALSE}
# Sets up global options for rendering RMarkdown into HTML.
knitr::opts_chunk$set(
    warning=FALSE,
    message=FALSE
)
```

```{r}
library(AnnotationHub)
library(dplyr)
```

# Functional enrichment analysis

Functional enrichment analysis tests to see if the genes of interest (e.g., up,
down, changed in a particular contrast) are found more often than expected in
a particular annotation category.

```{r load_helpers}
# Load the lcdbwf R package, which is stored locally.
# This package has many custom functions used throughout this document.
devtools::document('../../../lib/lcdbwf')
devtools::load_all('../../../lib/lcdbwf')

config <- lcdbwf::load_config('config.yaml')
```

```{r load, cache=TRUE, cache.extra=file.info('combined.Rds')$mtime}
obj <- readRDS('combined.Rds')
res_list <- obj$res_list
```

```{r functional_enrichment_prep, cache=TRUE, config=config$annotation$keytype, eval=config$toggle$functional_enrichment, dependson='load'}

# obtain ontology information
ontology_list <- get_ontology_list(config)
```

```{r enrich, cache=TRUE, eval=config$toggle$functional_enrichment, config=c(config$main, config$functional_enrichment), dependson=c('functional_enrichment_prep', 'assemble_variables')}
all_enrich <- list()

for (name in names(res_list)){
  all_enrich[[name]] <- list()

  for (direction in config$functional_enrichment$directions){
    all_enrich[[name]][[direction]] <- list()

    for (ont in names(config$functional_enrichment$ontologies)){
      term2gene <- ontology_list[[ont]]
      term2name <- ontology_term2name_mapping[[ont]]
      enrich_res <- lcdbwf::run_enrichment(
        res_list[[name]],
        direction=direction,
        TERM2GENE=term2gene,
        TERM2NAME=term2name,
        config=config,
        kind=config$functional_enrichment$kind
      )
      if (!is.null(enrich_res) && nrow(enrich_res@result) > 5){
        all_enrich[[name]][[direction]][[ont]] <- enrich_res
      } else {
        all_enrich[[name]][[direction]][[ont]] <- NULL
      }
    }
  }
}
```


```{r functional_enrichment_plots}
# Interestingly, it's the *caching* that causes this to hang for a loooong time.
dotplot_list <- lcdbwf::enrich_list_lapply(all_enrich, dotplots, config=config, send_names=TRUE)
emapplot_list <- lcdbwf::enrich_list_lapply(all_enrich, emapplots, config=config, send_names=TRUE)
cnetplot_list <- lcdbwf::enrich_list_lapply(all_enrich, cnetplots, config=config, send_names=TRUE)
```

```{r, results='asis'}
lcdbwf::mdcat("There are many different databases that annotate genes into sets.",
      "The following sets are used here:")

knitr::kable(config$functional_enrichment$ontologies %>% as.data.frame %>% t())
```

# Plots {.tabset}

```{r, results='asis'}

for (name in names(res_list)){
  mdcat("## ", name, "{.tabset}")
  for (direction in config$functional_enrichment$directions){
    mdcat("### ", direction, "{.tabset}")
    if (length(all_enrich[[name]][[direction]]) == 0){
      lcdbwf::mdcat("Too few genes differentially expressed.")
      next
    }
    for (ont in names(all_enrich[[name]][[direction]])){
      lcdbwf::mdcat("#### ", ont, "{.tabset}")

      lcdbwf::mdcat("##### dotplot")
      print(dotplot_list[[name]][[direction]][[ont]])

      lcdbwf::mdcat("##### emapplot")
      print(emapplot_list[[name]][[direction]][[ont]])

      lcdbwf::mdcat("##### cnetplot")
      print(cnetplot_list[[name]][[direction]][[ont]])
    }
  }
}


```

# Session info
For reproducibility purposes, here is the output of `sessionInfo()` showing the
versions of all packages used here.

```{r, collapse=FALSE}
sessionInfo()
```
