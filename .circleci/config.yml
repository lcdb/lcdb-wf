version: 2

variables:

  # default settings for all steps
  defaults: &defaults
    docker:
      - image: bioconda/bioconda-utils-build-env

  # --------------------------------------------------------------------------
  # The caching dramatically speeds up testing time, because we can do the
  # time-consuming step of conda environment creation once and then use that
  # for subsequent steps.
  #
  # The `initial-setup` job (defined in workflows below) saves the cache when
  # it's done. Here the cache is the miniconda directory. Later jobs
  # (chipseq-step, rnaseq-step, etc) restore that cache to dramatically speed
  # up testing time.
  #
  # The cache key is set to only re-make the cache when the relevant files
  # change. There's also a `v1-` prefix. This should be changed once in a while
  # just to re-trigger an environment rebuild (say, when some critical updates
  # hit bioconda).
  #
  # See https://circleci.com/docs/2.0/caching for details.

  save_cache: &save_cache
    save_cache:
      key: v1-{{ checksum "requirements.txt" }}-{{ checksum ".circleci/setup.sh" }}
      paths:
        - miniconda

  restore_cache: &restore_cache
    restore_cache:
      keys:
        - v1-{{ checksum "requirements.txt" }}-{{ checksum ".circleci/setup.sh" }}


  # --------------------------------------------------------------------------
  # Run the setup script, which installs miniconda, sets up bioconda, and
  # installs the global env
  setup: &setup
    run: 
      name: Setup conda
      command: .circleci/setup.sh
  # --------------------------------------------------------------------------


  # The path needs to be set each time
  set-path: &set-path
      run:
        name: Set path
        command: |
          echo 'export PATH=$PATH:/root/project/miniconda/bin' >> $BASH_ENV
          source $BASH_ENV
jobs:

  # Builds the global conda environment, lcdb-wf-test, and then saves the
  # `miniconda` dir to the cache which can be restored in later jobs.
  initial-setup:
    <<: *defaults
    steps:
      - checkout
      - *restore_cache
      - *setup
      - *save_cache

  build-docs:
    <<: *defaults
    steps:
      - add_ssh_keys:
          fingerprints:
            - 2d:0c:b4:27:44:cf:f4:50:cc:14:a4:2b:c2:3c:09:06
      - checkout
      - *restore_cache
      - *set-path
      - run:
          name: Install sphinx
          command: conda install sphinx -y
      - run:
          name: OK for unknown github host
          command: mkdir -p ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - run:
          name: Install git
          command: yum install git -y
      - run:
          name: Build and upload docs
          command: source activate lcdb-wf-test && ci/build-docs.sh


workflows:
  version: 2
  test-suite:
    jobs:
      - initial-setup
      - build-docs:
          requires:
            - initial-setup
